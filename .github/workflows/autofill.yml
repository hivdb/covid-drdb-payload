name: Autofill

on:
  pull_request_target:
    branches: [ master, autofill-action ]

jobs:
  autofill:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout payload repository
      uses: actions/checkout@v2
      with:
        path: covid-drdb-payload

    - name: Checkout covid-drdb repository
      uses: actions/checkout@v2
      with:
        repository: hivdb/covid-drdb
        path: covid-drdb

    - name: Checkout PR
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd covid-drdb-payload
        gh pr checkout ${{ github.event.pull_request.number }}

    - name: Run autofill-payload
      run: |
        set -e
        cd covid-drdb
        ln -s ../covid-drdb-payload payload
        docker run --rm -v $GITHUB_WORKSPACE/covid-drdb:/covid-drdb -v $GITHUB_WORKSPACE/covid-drdb-payload:/covid-drdb-payload hivdb/covid-drdb-builder:latest pipenv run python -m drdb.entry autofill-payload /covid-drdb-payload

    - name: Check for changes and commit
      id: check_changes
      run: |
        git config --global user.name "HIVDB Bot"
        git config --global user.email "hivdbteam@stanford.edu"
        cd covid-drdb-payload
        git add .
        git diff --cached --quiet || git commit -m "Autogenerated data updated by HIVDB Bot"
        echo "committed=$?" >> $GITHUB_ENV

    - name: Push changes
      if: env.committed == 0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        cd covid-drdb-payload
        git remote add headrepo https://${GITHUB_TOKEN}@github.com/${{ github.event.pull_request.head.repo.full_name }}.git
        git push headrepo ${{ github.event.pull_request.head.ref }}
        gh pr edit ${{ github.event.pull_request.number }} --add-label "autofilled"

    - name: Post success message
      if: success() && env.committed == 0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd covid-drdb-payload
        gh pr comment ${{ github.event.pull_request.number }} --body "Autofill action completed successfully. Autogenerated data has been updated."

    - name: Post no change message
      if: success() && env.committed != 0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd covid-drdb-payload
        gh pr comment ${{ github.event.pull_request.number }} --body "Autofill action completed successfully. No changes were detected in the autogenerated data."

    - name: Post failure message
      if: failure()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd covid-drdb-payload
        gh pr comment ${{ github.event.pull_request.number }} --body "Autofill action failed. Please check the logs for more information."
